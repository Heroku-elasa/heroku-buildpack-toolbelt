#!/bin/bash
echo "*** Installing Heroku Toolbelt ***"

#set -e

if [[ "$HOME" = "" ]];then
	Current_DIR="$PWD"
	echo 'Current_DIR is:'
	echo $Current_DIR
else
	echo 'Current_DIR is home:'
	echo $Current_DIR
    Current_DIR="$HOME"
fi

if [[ "$OPENSHIFT_LOG_DIR" = "" ]];then
	#echo "$OPENSHIFT_LOG_DIR" > "$OPENSHIFT_HOMEDIR/.env/OPENSHIFT_DIY_LOG_DIR"
    if [ ! -d ${Current_DIR}/openshifts ]; then	        
	    mkdir  ${Current_DIR}/openshifts
    fi
	
    if [ ! -d ${Current_DIR}/openshifts/logs ]; then	
        mkdir ${Current_DIR}/openshifts/logs
    fi
	
	export OPENSHIFT_LOG_DIR="$Current_DIR/openshifts/logs/"
	echo 'OPENSHIFT_LOG_DIR is:'
	echo $OPENSHIFT_LOG_DIR
else
   echo "$OPENSHIFT_LOG_DIR Exists"
fi

if [[ "$OPENSHIFT_TMP_DIR" = "" ]]; then	
	#mkdir  ${Current_DIR}/openshifts
    if [ ! -d ${Current_DIR}/openshifts/tmp ]; then	
        mkdir ${Current_DIR}/openshifts/tmp
    fi
	export OPENSHIFT_TMP_DIR="$Current_DIR/openshifts/tmp/"
	echo 'OPENSHIFT_TMP_DIR2 is:'
	echo $OPENSHIFT_TMP_DIR
fi


if [ "$OPENSHIFT_HOMEDIR" = "" ]; then	
	if [ ! -d ${Current_DIR}/openshifts/app-root ]; then	
        mkdir ${Current_DIR}/openshifts/app-root
	fi
	
	if [ ! -d ${Current_DIR}/openshifts/app-root/runtime ]; then	
        mkdir ${Current_DIR}/openshifts/app-root/runtime
	fi
	
	
	export OPENSHIFT_HOMEDIR="$Current_DIR/openshifts/"
	echo 'OPENSHIFT_HOMEDIR is:'
	echo $OPENSHIFT_HOMEDIR
else
	echo 'OPENSHIFT_HOMEDIR exist:'
	echo $OPENSHIFT_HOMEDIR
fi

if [ "$OPENSHIFT_REPO_DIR" = "" ]; then	
	OPENSHIFT_REPO_DIR=$OPENSHIFT_HOMEDIR
	echo 'OPENSHIFT_REPO_DIR is:'
	echo $OPENSHIFT_REPO_DIR
fi
if [ "OPENSHIFT_REPO_DIR" = "" ]; then	
	OPENSHIFT_REPO_DIR="$PWD"
	echo 'OPENSHIFT_REPO_DIR is:'
	echo $OPENSHIFT_REPO_DIR
fi
echo 'Current_DIR is:'
echo ${Current_DIR}

if [  -d ${Current_DIR}/.openshift/action_hooks/common ]; then	
    source ${Current_DIR}/.openshift/action_hooks/common
fi


if [ ! -d ${OPENSHIFT_HOMEDIR}/app-root/runtime/srv ]; then	
    mkdir ${OPENSHIFT_HOMEDIR}/app-root/runtime/srv
	echo 'mkdir is:'
	echo ${OPENSHIFT_HOMEDIR}/app-root/runtime/srv
fi
rm -rf $OPENSHIFT_TMP_DIR/*


#BUILD_DIR=$1
#CACHE_DIR=$2
cd $OPENSHIFT_TMP_DIR
rm -rf *
BUILD_DIR=$OPENSHIFT_HOMEDIR/app-root/runtime/srv/heroku
CACHE_DIR=$OPENSHIFT_HOMEDIR/app-root/runtime/tmp/

mkdir $OPENSHIFT_HOMEDIR/app-root/runtime/srv

mkdir $OPENSHIFT_HOMEDIR/app-root/runtime/tmp/
mkdir  $OPENSHIFT_HOMEDIR/app-root/runtime/srv/heroku

mkdir -p $CACHE_DIR
mkdir -p $BUILD_DIR

curl -s -L -o $CACHE_DIR/heroku-client.tgz https://s3.amazonaws.com/assets.heroku.com/heroku-client/heroku-client.tgz
cd $CACHE_DIR
tar xf heroku-client.tgz

mv $CACHE_DIR/heroku-client $BUILD_DIR

export PATH="$BUILD_DIR/heroku-client/bin":$PATH
PROFILE_PATH="$BUILD_DIR/.profile.d/heroku-toolbelt.sh"
mkdir -p $(dirname $PROFILE_PATH)
echo 'export PATH="$OPENSHIFT_HOMEDIR/app-root/runtime/srv/heroku/heroku-client/bin:$PATH"' > $PROFILE_PATH

heroku plugins:install heroku-redis
heroku --version

echo "*** Heroku Toolbelt installed ***"
